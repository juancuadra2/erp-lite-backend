{
  "module": "warehouses",
  "featureId": "08-warehouses",
  "estimatedStoryPoints": 43,
  "priority": "P1",
  "complexity": "MEDIUM",
  "description": "Módulo de catálogo de bodegas. Prerequisito directo de 07-inventory (stock.warehouse_id). Patrón estándar hexagonal igual a 05-units-of-measure.",
  "blockedBy": [],
  "blocks": ["07-inventory"],
  "phases": [
    {
      "id": "PHASE-1",
      "name": "Foundation & Domain",
      "storyPoints": 9,
      "tasks": [
        {
          "id": "WH-001",
          "title": "Crear enum WarehouseType",
          "description": "Crear enum en domain/model/warehouse/WarehouseType.java con valores: PRINCIPAL, SUCURSAL, CONSIGNACION, TEMPORAL",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-002",
          "title": "Crear domain model Warehouse",
          "description": "Crear clase Warehouse con @Getter @Builder @AllArgsConstructor. Incluir métodos de ciclo de vida: activate(), deactivate(), softDelete(), isDeleted()",
          "storyPoints": 2,
          "status": "pending"
        },
        {
          "id": "WH-003",
          "title": "Crear excepciones de dominio",
          "description": "Crear en domain/exception/warehouse/: WarehouseNotFoundException, DuplicateWarehouseCodeException, DuplicateWarehouseNameException, WarehouseInUseException, InvalidWarehouseDataException, SinglePrincipalWarehouseException",
          "storyPoints": 2,
          "status": "pending"
        },
        {
          "id": "WH-004",
          "title": "Crear WarehouseRepository port",
          "description": "Crear interfaz en domain/port/warehouse/WarehouseRepository.java con métodos: save, findByUuid, findAll (con filtros), findAllActive, existsByCode*, existsByName*, existsActivePrincipal*",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-005",
          "title": "Crear WarehouseValidator",
          "description": "Validaciones estructurales sin dependencias externas: código (3-20 chars, [A-Z0-9\\-]+), nombre (3-100), tipo (requerido), email (formato si provisto), teléfono (formato si provisto)",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-006",
          "title": "Crear WarehouseDomainService",
          "description": "Reglas de negocio que usan el repositorio: validar unicidad de código, unicidad de nombre, regla de bodega PRINCIPAL única activa, normalización de código (toUpperCase, trim)",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-007",
          "title": "Crear WarehouseValidationService",
          "description": "Validaciones de integridad referencial: validateDeletable(Warehouse) y validateDeactivatable(UUID). validateDeletable verifica: (1) BR-03.3: si la bodega es PRINCIPAL y está activa lanza WarehouseInUseException (funcional desde el inicio); (2) BR-03.1: si tiene stock activo lanza WarehouseInUseException (stub inicial, se completa en 07-inventory). validateDeactivatable: verifica transferencias pendientes (stub inicial).",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    },
    {
      "id": "PHASE-2",
      "name": "Database Schema & Migration",
      "storyPoints": 4,
      "tasks": [
        {
          "id": "WH-008",
          "title": "Crear migración Flyway V13__create_warehouses_table.sql",
          "description": "Crear tabla warehouses. Columna de municipio: municipality_uuid VARCHAR(36) (sin FK de BD, referencia lógica). Índices en uuid, code, type, active, municipality_uuid. Sin UNIQUE en name (unicidad gestionada en dominio).",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-009",
          "title": "Crear migración Flyway V14__insert_warehouses_seed_data.sql",
          "description": "Insertar 2 bodegas de ejemplo: BOD-001 (Bodega Principal - PRINCIPAL) y BOD-002 (Sucursal Norte - SUCURSAL). Script idempotente.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-010",
          "title": "Sincronizar scripts docker/mysql-init/",
          "description": "Crear 13_create_warehouses_table.sql y 14_insert_warehouses_seed_data.sql en docker/mysql-init/ con el mismo contenido que las migraciones Flyway.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-011",
          "title": "Verificar compatibilidad H2 para tests",
          "description": "Asegurar que el DDL de la tabla warehouses sea compatible con H2 en modo MySQL (ddl-auto=create-drop, sin Flyway en tests).",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    },
    {
      "id": "PHASE-3",
      "name": "Persistence Layer (Output Adapters)",
      "storyPoints": 6,
      "tasks": [
        {
          "id": "WH-012",
          "title": "Crear WarehouseEntity (JPA)",
          "description": "Entidad JPA con @Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder. @Enumerated(EnumType.STRING) en type. No usar @Data. Campo municipalityUuid como String (columna municipality_uuid VARCHAR(36)), sin FK JPA hacia Municipality.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-013",
          "title": "Crear WarehouseJpaRepository",
          "description": "Interfaz que extiende JpaRepository<WarehouseEntity, Long> y JpaSpecificationExecutor. Declarar métodos de búsqueda: findByUuid, findByActiveTrue, existsByCodeIgnoreCase, existsByNameIgnoreCase, etc.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-014",
          "title": "Crear WarehouseEntityMapper (MapStruct)",
          "description": "Mapper MapStruct con componentModel=SPRING para domain ↔ entity. Mapeos con nombres distintos: domain.uuid (UUID) ↔ entity.uuid (String); domain.municipalityId (UUID) ↔ entity.municipalityUuid (String). MapStruct convierte UUID↔String automáticamente; declarar @Mapping(source='municipalityId', target='municipalityUuid') y viceversa.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-015",
          "title": "Crear WarehouseRepositoryAdapter",
          "description": "Implementar WarehouseRepository usando WarehouseJpaRepository + WarehouseEntityMapper. @Component @RequiredArgsConstructor. Implementar todos los métodos del port.",
          "storyPoints": 2,
          "status": "pending"
        },
        {
          "id": "WH-016",
          "title": "Crear WarehouseSpecificationUtil",
          "description": "Utilidad para construir JPA Specification a partir de filtros: active (Boolean), type (String → WarehouseType.valueOf), municipalityId (UUID → toString para comparar municipalityUuid), name (like), code (like). Siempre añadir 'deletedAt IS NULL' como predicado base para excluir soft-deleted.",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    },
    {
      "id": "PHASE-4",
      "name": "Application Layer (Use Cases)",
      "storyPoints": 6,
      "tasks": [
        {
          "id": "WH-017",
          "title": "Crear CreateWarehouseCommand",
          "description": "Record con campos: code, name, description, type (WarehouseType), address, municipalityId, responsible, email, phone",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-018",
          "title": "Crear UpdateWarehouseCommand",
          "description": "Record con campos: name, description, type (WarehouseType), address, municipalityId, responsible, email, phone (code no es actualizable)",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-019",
          "title": "Crear ManageWarehouseUseCase (interfaz)",
          "description": "Interfaz en application/port/warehouse/ con métodos: create(CreateWarehouseCommand), update(UUID, UpdateWarehouseCommand), delete(UUID), activate(UUID), deactivate(UUID)",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-020",
          "title": "Crear CompareWarehouseUseCase (interfaz)",
          "description": "Interfaz en application/port/warehouse/ con métodos: findByUuid(UUID), findAll(Map filters, Pageable), findAllActive()",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-021",
          "title": "Crear ManageWarehouseUseCaseImpl",
          "description": "Implementar ManageWarehouseUseCase usando WarehouseRepository, WarehouseDomainService y WarehouseValidationService (ver DT-06). @Transactional en operaciones de escritura. Declarar en BeanConfiguration (no @Service).",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-022",
          "title": "Crear CompareWarehouseUseCaseImpl",
          "description": "Implementar CompareWarehouseUseCase usando WarehouseRepository. Lanzar WarehouseNotFoundException cuando no se encuentre. Declarar en BeanConfiguration.",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    },
    {
      "id": "PHASE-5",
      "name": "Web Layer (Input Adapters)",
      "storyPoints": 8,
      "tasks": [
        {
          "id": "WH-023",
          "title": "Crear CreateWarehouseRequestDto",
          "description": "Record con Jakarta Validation: @NotBlank en code/name, @Size en todos los strings, @Pattern en code ([A-Z0-9\\-]+), @Email en email, @Pattern en phone. @NotNull en type.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-024",
          "title": "Crear UpdateWarehouseRequestDto",
          "description": "Record con mismas validaciones que Create excepto code (no se actualiza). name y type son requeridos en update.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-025",
          "title": "Crear WarehouseResponseDto",
          "description": "Record con: uuid, code, name, description, type, address, municipalityId, responsible, email, phone, active, createdAt, updatedAt",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-026",
          "title": "Crear WarehouseDtoMapper (MapStruct)",
          "description": "Mapper con componentModel=SPRING para domain ↔ DTO. Métodos: toCreateCommand(dto), toUpdateCommand(dto), toResponseDto(domain).",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-027",
          "title": "Crear WarehouseController",
          "description": "Controller REST con @RequestMapping('/api/v1/warehouses'). Implementar 7 endpoints: POST, GET/{uuid}, GET (paginado), PUT/{uuid}, DELETE/{uuid}, PATCH/{uuid}/activate, PATCH/{uuid}/deactivate. @PreAuthorize en endpoints de escritura.",
          "storyPoints": 2,
          "status": "pending"
        },
        {
          "id": "WH-028",
          "title": "Actualizar BeanConfiguration",
          "description": "Agregar beans: warehouseValidator(), warehouseValidationService(repository), warehouseDomainService(validator, repository), manageWarehouseUseCase(repository, domainService, validationService), compareWarehouseUseCase(repository). Sin comentarios decorativos. Ver DT-05 y DT-06.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-029",
          "title": "Actualizar GlobalExceptionHandler",
          "description": "Agregar handlers para: WarehouseNotFoundException (404), DuplicateWarehouseCodeException (409), DuplicateWarehouseNameException (409), WarehouseInUseException (409), InvalidWarehouseDataException (400), SinglePrincipalWarehouseException (409)",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    },
    {
      "id": "PHASE-6",
      "name": "Testing & Quality",
      "storyPoints": 7,
      "tasks": [
        {
          "id": "WH-030",
          "title": "Tests unitarios: Warehouse domain model",
          "description": "Tests para métodos de ciclo de vida: activate(), deactivate(), softDelete(), isDeleted(). Verificar estado antes y después de cada transición.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-031",
          "title": "Tests unitarios: WarehouseValidator",
          "description": "Tests para todas las validaciones estructurales. Usar @ParameterizedTest con valores válidos e inválidos para code, name, email, phone.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-032",
          "title": "Tests unitarios: WarehouseDomainService",
          "description": "Tests para: normalización de código, validación de unicidad (código y nombre), regla de bodega PRINCIPAL única, preparación para create/update.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-033",
          "title": "Tests unitarios: ManageWarehouseUseCaseImpl",
          "description": "Tests con Mockito para: create (exitoso y con duplicados), update, delete (sin stock y con stock), activate, deactivate. Verificar interacciones con mocks.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-034",
          "title": "Tests unitarios: CompareWarehouseUseCaseImpl",
          "description": "Tests con Mockito para: findByUuid (encontrado y no encontrado), findAll con filtros y paginación, findAllActive.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-035",
          "title": "Tests unitarios: WarehouseEntityMapper y WarehouseDtoMapper",
          "description": "Tests de mapeo completo bidireccional (domain ↔ entity, domain ↔ dto). Verificar que no se pierdan campos. Manejar null en campos opcionales.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-036",
          "title": "Tests unitarios: WarehouseController",
          "description": "Tests con MockMvc para todos los endpoints. Verificar status HTTP, body de respuesta y llamadas a use cases. Incluir escenarios de error (404, 409, 400, 204).",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-037",
          "title": "Tests unitarios: WarehouseValidationService",
          "description": "Tests para validateDeletable(Warehouse): (1) bodega PRINCIPAL activa → WarehouseInUseException (BR-03.3 funcional); (2) bodega no-PRINCIPAL o inactiva → sin excepción (BR-03.1 stub). Tests para validateDeactivatable: stub, no lanza excepción.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-038",
          "title": "Tests unitarios: WarehouseRepositoryAdapter",
          "description": "Tests unitarios del adapter con mocks de WarehouseJpaRepository y WarehouseEntityMapper. Cubrir todos los métodos del port: save, findByUuid, findAll (con SpecificationUtil), findAllActive, todos los existsBy*.",
          "storyPoints": 1,
          "status": "pending"
        },
        {
          "id": "WH-039",
          "title": "Tests unitarios: WarehouseSpecificationUtil",
          "description": "Tests para cada filtro de la Specification: active, type, municipalityUuid (UUID→String), name (like), code (like). Verificar que registros con deletedAt != null sean excluidos por defecto. Verificar combinación de filtros.",
          "storyPoints": 1,
          "status": "pending"
        }
      ]
    }
  ],
  "notes": [
    "Módulo prerequisito de 07-inventory: debe implementarse antes que inventory.",
    "Sigue el mismo patrón que 05-units-of-measure y 03-payment-methods.",
    "municipalityId: UUID en toda la API; almacenado como VARCHAR(36) en entidad (campo municipalityUuid). Sin FK de BD. Ver DT-02.",
    "WarehouseDomainService recibe (WarehouseValidator, WarehouseRepository): gestiona unicidad y BR-02.2. Ver DT-05.",
    "ManageWarehouseUseCaseImpl recibe (WarehouseRepository, WarehouseDomainService, WarehouseValidationService). Ver DT-06.",
    "WarehouseValidationService.validateDeletable(Warehouse): BR-03.3 funcional desde el inicio. BR-03.1 (stock activo) es stub; se completa en 07-inventory.",
    "BR-04.3 ELIMINADA: código bloqueado permanentemente. DB UNIQUE en code se mantiene.",
    "Seed data en V14 usa INSERT IGNORE para idempotencia; la migración V13 es obligatoria.",
    "Los tests deben usar @ExtendWith(MockitoExtension.class) sin Spring context."
  ]
}
