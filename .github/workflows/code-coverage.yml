name: Code Coverage Validation

on:
  pull_request:
    branches:
      - main

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Run tests with coverage
      run: mvn clean test jacoco:report
      
    - name: Check total coverage
      id: total-coverage
      run: |
        # Extract total coverage from JaCoCo CSV
        COVERAGE=$(awk -F, '
        BEGIN {
          instructions_covered = 0
          instructions_total = 0
        }
        NR>1 {
          instructions_covered += $5
          instructions_total += $4 + $5
        }
        END {
          if (instructions_total > 0) {
            coverage = (instructions_covered / instructions_total) * 100
            printf "%.2f", coverage
          } else {
            print "0"
          }
        }' target/site/jacoco/jacoco.csv)
        
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Total coverage: ${COVERAGE}%"
        
        # Check if coverage meets minimum threshold of 90%
        THRESHOLD=90
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "‚ùå Total coverage ${COVERAGE}% is below the required ${THRESHOLD}%"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "‚úÖ Total coverage ${COVERAGE}% meets the minimum ${THRESHOLD}% requirement"
          echo "status=passed" >> $GITHUB_OUTPUT
        fi
        
    - name: Check coverage for changed files
      id: changed-coverage
      run: |
        # Get list of changed Java files
        git fetch origin main
        CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep '\.java$' | grep '^src/main/' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No Java source files changed in this PR"
          echo "status=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Changed Java files:"
        echo "$CHANGED_FILES"
        echo ""
        
        # Parse JaCoCo CSV report for changed files coverage
        FAILED=0
        
        while IFS= read -r file; do
          # Convert file path to package and class name
          # Remove src/main/java/ prefix and .java suffix
          CLASS_PATH=$(echo "$file" | sed 's|^src/main/java/||' | sed 's|\.java$||')
          PACKAGE=$(echo "$CLASS_PATH" | sed 's|/[^/]*$||' | tr '/' '.')
          CLASS=$(echo "$CLASS_PATH" | sed 's|.*/||')
          
          # Search for the class in JaCoCo CSV report
          COVERAGE_LINE=$(grep ",$PACKAGE,$CLASS," target/site/jacoco/jacoco.csv || echo "")
          
          if [ -z "$COVERAGE_LINE" ]; then
            echo "‚ö†Ô∏è  No coverage data found for $CLASS_PATH (might be an interface, abstract class, or not compiled)"
            continue
          fi
          
          # Extract coverage metrics from CSV (columns: INSTRUCTION_MISSED, INSTRUCTION_COVERED)
          MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f4)
          COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f5)
          
          TOTAL=$((MISSED + COVERED))
          
          if [ "$TOTAL" -eq 0 ]; then
            echo "‚ö†Ô∏è  No executable code found in $CLASS_PATH"
            continue
          fi
          
          COVERAGE=$((COVERED * 100 / TOTAL))
          
          echo "Coverage for $CLASS_PATH: ${COVERAGE}% (${COVERED}/${TOTAL} instructions)"
          
          if [ "$COVERAGE" -lt 100 ]; then
            echo "‚ùå $CLASS_PATH has ${COVERAGE}% coverage (requires 100%)"
            FAILED=1
          else
            echo "‚úÖ $CLASS_PATH has 100% coverage"
          fi
        done <<< "$CHANGED_FILES"
        
        if [ "$FAILED" -eq 1 ]; then
          echo ""
          echo "‚ùå Some changed files do not have 100% coverage"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        else
          echo ""
          echo "‚úÖ All changed files have 100% coverage"
          echo "status=passed" >> $GITHUB_OUTPUT
        fi
        
    - name: Comment PR
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.total-coverage.outputs.coverage }}' || 'N/A';
          const totalStatus = '${{ steps.total-coverage.outputs.status }}' || 'unknown';
          const changedStatus = '${{ steps.changed-coverage.outputs.status }}' || 'unknown';
          
          const totalIcon = totalStatus === 'passed' ? '‚úÖ' : totalStatus === 'failed' ? '‚ùå' : '‚ö†Ô∏è';
          const changedIcon = changedStatus === 'passed' ? '‚úÖ' : changedStatus === 'failed' ? '‚ùå' : changedStatus === 'skipped' ? '‚è≠Ô∏è' : '‚ö†Ô∏è';
          
          const comment = `## üìä Code Coverage Report
          
          **Total Coverage:** ${coverage}% ${totalIcon}
          
          ### Requirements
          - ${totalIcon} Total coverage must be ‚â• 90% (Current: ${coverage}%)
          - ${changedIcon} New/changed files must have 100% coverage
          
          For detailed coverage report, check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
